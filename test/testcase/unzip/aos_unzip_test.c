/*
 * Copyright (C) 2020-2023 Alibaba Group Holding Limited
 */

#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <errno.h>
#include <ztest.h>
#include "aos/vfs.h"
#include "aos_unzip.h"

#define ZIP_FILE "/jsamp/test.zip"
#define UNZIP_FILE "/jsamp/unzip/test.txt"
#define UNZIP_DIR "/jsamp/unzip"

const char test_zip_str[] = {
    0x50, 0x4B, 0x03, 0x04, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8B, 0x8C, 0xDA, 0x56,
    0x6E, 0x93, 0xF4, 0x30, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x08, 0x00,
    0x1C, 0x00, 0x74, 0x65, 0x73, 0x74, 0x2E, 0x74, 0x78, 0x74, 0x55, 0x54, 0x09, 0x00,
    0x03, 0x16, 0x5C, 0x99, 0x64, 0x17, 0x5C, 0x99, 0x64, 0x75, 0x78, 0x0B, 0x00, 0x01,
    0x04, 0xF6, 0x01, 0x00, 0x00, 0x04, 0x14, 0x00, 0x00, 0x00, 0x74, 0x68, 0x69, 0x73,
    0x20, 0x69, 0x73, 0x20, 0x61, 0x20, 0x74, 0x65, 0x73, 0x74, 0x2E, 0x0A, 0x50, 0x4B,
    0x01, 0x02, 0x1E, 0x03, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8B, 0x8C, 0xDA, 0x56,
    0x6E, 0x93, 0xF4, 0x30, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x08, 0x00,
    0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xA4, 0x81, 0x00, 0x00,
    0x00, 0x00, 0x74, 0x65, 0x73, 0x74, 0x2E, 0x74, 0x78, 0x74, 0x55, 0x54, 0x05, 0x00,
    0x03, 0x16, 0x5C, 0x99, 0x64, 0x75, 0x78, 0x0B, 0x00, 0x01, 0x04, 0xF6, 0x01, 0x00,
    0x00, 0x04, 0x14, 0x00, 0x00, 0x00, 0x50, 0x4B, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x01, 0x00, 0x4E, 0x00, 0x00, 0x00, 0x52, 0x00, 0x00, 0x00, 0x00, 0x00};

static int test_aos_uz(void)
{
    int file;
    int res;
    size_t str_len;
    const char test_str[] = "this is a test.";
    char str_buff[80];

    // create and write file
    file = aos_open(ZIP_FILE, O_CREAT | O_RDWR);
    zassert_true(file >= 0, "Failed create file [%d], errno [%d]\n", file, errno);
    if (file < 0)
    {
        aos_close(file);
        return TC_FAIL;
    }

    res = aos_write(file, (char *)test_zip_str, sizeof(test_zip_str));
    zassert_true(res >= 0, "Failed writing to file [%d]\n", (int)res);
    if (res < 0)
    {
        aos_close(file);
        return TC_FAIL;
    }

    aos_close(file);
    printf("File created and written successfully\n");

    // unzip files
    res = aos_unzip(ZIP_FILE, UNZIP_DIR);
    zassert_equal(res, 0, "aos_unzip failed\n");
    if (res != 0)
    {
        TC_PRINT("Failed unzip file [%d]\n", file);
        return TC_FAIL;
    }

    // check if files existance
    file = aos_open(UNZIP_DIR "/test.txt", O_RDONLY);
    if (file < 0)
    {
        TC_PRINT("Not found - unzip file [%d] not found \n", file);
        return TC_FAIL;
    }

    res = aos_read(file, str_buff, strlen(test_str));
    if (res < 0)
    {
        TC_PRINT("Failed reading file [%d]\n", (int)res);
        aos_close(file);
        return TC_FAIL;
    }
    if (strcmp(test_str, str_buff))
    {
        TC_PRINT("Error - Data read does not match data written\n");
        TC_PRINT("Data read:\"%s\"\n\n", str_buff);
        return TC_FAIL;
    }

    res = aos_close(file);

    // clear files
    aos_remove(ZIP_FILE);
    aos_remove(UNZIP_FILE);
    aos_rmdir(UNZIP_DIR);

    return TC_PASS;
}

void test_aos_unzip(void)
{
    YUNIT_ASSERT(test_aos_uz() == TC_PASS)
}
